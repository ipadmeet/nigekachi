<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            font-family: Arial, sans-serif;
        }
        #report-form, #login-form {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* ğŸ”¹å³ä¸Šã®ãƒ–ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ */
        .book-icon {
            position: fixed;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            text-decoration: none;
        }

    </style>
</head>
<body>
    
<!-- ğŸ”¹å³ä¸Šãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ -->
<a class="book-icon" href="https://sites.google.com/view/incict-design" target="_blank">ğŸ“˜</a>

<div class="container">

 

    <!-- ğŸ”¹ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="login-form">
        <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width: 90%; margin-bottom:10px;"><br>
        <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 90%; margin-bottom:10px;"><br>
        <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <p id="login-status"></p>
    </div>

    <!-- ğŸ”¹æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="report-form" style="display: none;">
        <label for="report-datetime">æ—¥æ™‚:</label><br>
        <input type="datetime-local" id="report-datetime" style="margin-bottom: 10px; width: 90%;"><br>

        <label for="description">çŠ¶æ³ã®è©³ç´°:</label><br>
        <textarea id="description" rows="3" cols="50" style="width: 90%;"></textarea><br><br>

        <button onclick="submitReport()">æŠ•ç¨¿ã™ã‚‹</button>
    </div>

    <div id="map"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
        authDomain: "danger-e17d4.firebaseapp.com",
        projectId: "danger-e17d4",
        storageBucket: "danger-e17d4.firebasestorage.app",
        messagingSenderId: "671800740218",
        appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let map;
    let selectedLocation = null;
    let tempMarker = null;

    // ğŸ”¹ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById("report-form").style.display = "block";
            document.getElementById("login-status").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
        } else {
            document.getElementById("report-form").style.display = "none";
            document.getElementById("login-status").textContent = "æŠ•ç¨¿ã§ãã‚‹ã®ã¯ãƒ‹ã‚²ã‚«ãƒã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ã§ã™ã€‚ãƒ‹ã‚²ã‚«ãƒã®ãƒ¡ãƒ³ãƒãƒ¼ã«ãªã£ã¦ã„ãŸã ã‘ã‚‹æ–¹ã¯ã€Œæœ¬ã€ãƒãƒ¼ã‚¯ã‹ã‚‰ãŠå•åˆã›ãã ã•ã„ã€‚ã¾ãŸã¯ã€å±é™ºæƒ…å ±ã‚’ãŠå•åˆã›ã‚ˆã‚ŠãŠä¼ãˆãã ã•ã„ã€‚";
        }
    });

    function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.signInWithEmailAndPassword(email, password)
            .catch(() => alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"));
    }

    function logout() {
        auth.signOut();
    }

    function initMap() {
        const initialPos = { lat: 36.3658, lng: 140.4764 };

        map = new google.maps.Map(document.getElementById("map"), {
            center: initialPos,
            zoom: 16,
        });

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ”ãƒ³è¨­ç½®
        map.addListener("click", (e) => {
            if (!auth.currentUser) {
                alert("æŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
                return;
            }

            selectedLocation = {
                lat: e.latLng.lat(),
                lng: e.latLng.lng()
            };

            if (tempMarker) tempMarker.setMap(null);

            tempMarker = new google.maps.Marker({
                position: selectedLocation,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });
        });

        listenForReports();
    }

    function listenForReports() {
        db.collection("reports").onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const data = change.doc.data();
                if (change.type === "added") {
                    const marker = new google.maps.Marker({
                        position: new google.maps.LatLng(data.latitude, data.longitude),
                        map: map,
                        icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                    });

                    const t = data.reportTimestamp ?
                        new Date(data.reportTimestamp.toDate()).toLocaleString() : "ä¸æ˜";

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <h3>å±é™ºç®‡æ‰€</h3>
                            <strong>æ—¥æ™‚:</strong> ${t}<br>
                            <strong>è©³ç´°:</strong> ${data.description}<br>
                            <strong>æŠ•ç¨¿è€…:</strong> ${data.username}
                        `
                    });

                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });
                }
            });
        });
    }

    function submitReport() {
        if (!auth.currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        if (!selectedLocation) return alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„");
        if (!description.value.trim()) return alert("çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const d = new Date(document.getElementById("report-datetime").value);

        db.collection("reports").add({
            latitude: selectedLocation.lat,
            longitude: selectedLocation.lng,
            description: description.value,
            username: "ãƒ‹ã‚²ã‚«ãƒ",
            reportTimestamp: firebase.firestore.Timestamp.fromDate(d),
            created: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("æŠ•ç¨¿ã—ã¾ã—ãŸ");
        description.value = "";
        if (tempMarker) tempMarker.setMap(null);
        selectedLocation = null;
    }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap"></script>

</body>
</html>
